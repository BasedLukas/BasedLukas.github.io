# CLAUDE.md

## Overview

Personal blog at **loreley.one** built with Hexo (v7.1.1) using a custom dark-themed `clean-blog` theme. Deploys to GitHub Pages via `hexo deploy`.

## Commands

```bash
npm install          # Install dependencies
hexo clean           # Clear generated files and cache
hexo serve           # Local dev server (localhost:4000)
hexo generate        # Build static files to public/
hexo deploy          # Deploy to GitHub Pages
hexo new post "title"  # Create new post (uses scaffold)
hexo new page "name"   # Create new page
```

Always run `hexo clean` before `hexo generate` or `hexo serve` when debugging rendering issues.

## Architecture

### Hexo Config (`_config.yml`)

- **Syntax highlighting**: Prism.js (`prismjs.enable: true`, `highlight.enable: false`). Both cannot be true simultaneously — Hexo ignores Prism when highlight is enabled.
- **Math**: `hexo-math` plugin renders KaTeX at build time. No client-side math JS needed.
- **Post assets**: `post_asset_folder: true` — each post gets a sibling directory for images/files.
- **Permalink format**: `:year-:month-:title/`
- **Sitemap**: Auto-generated by `hexo-generator-sitemap`
- **RSS**: Atom feed via `hexo-generator-feed`
- **Analytics**: Tinybird (token in config)

### Theme Structure (`themes/clean-blog/`)

```
layout/
  layout.ejs              # Root wrapper (skip-link, nav, main, footer, scripts)
  index.ejs               # Homepage (hero + post list)
  post.ejs                # Blog post wrapper
  page.ejs                # Generic pages + tag/category indexes
  archive.ejs             # Archive listing
  _partial/
    head.ejs              # <head> with SEO meta, OG tags, JSON-LD, fonts, CSS
    menu.ejs              # Fixed nav with hamburger toggle
    footer.ejs            # Minimal footer (copyright, RSS, GitHub, Twitter links)
    after-footer.ejs      # Prism CDN, main.js, analytics
    article-full.ejs      # Post layout (header, body, TOC sidebar)
    pagination.ejs        # Prev/next pagination
    tag-category-index.ejs # Tag and category listing pages
source/
  css/style.css           # All styles (dark theme, CSS variables)
  js/main.js              # Client-side enhancements
```

### CSS (`style.css`)

Single file with CSS custom properties for the entire design system. Key variables:

- `--bg-primary: #0b0b0c` (page background)
- `--accent: #c8b89a` (gold accent)
- `--text-primary: #e8e4dd` (main text)
- `--font-serif: 'Instrument Serif'` (headings)
- `--font-sans: 'DM Sans'` (body)
- `--font-mono: 'IBM Plex Mono'` (code, nav links, meta)

### JavaScript (`main.js`)

IIFE that runs on DOMContentLoaded. Functions:

| Function | Purpose |
|----------|---------|
| `enhanceCodeBlocks()` | Wraps `figure.highlight` in `.code-block` div with language label + copy button |
| `enhanceMathBlocks()` | Wraps `.katex-display` in `.math-block` divs |
| `wrapTables()` | Adds overflow scroll wrapper to tables in post body |
| `initCollapse()` | Event delegation for `data-toggle="collapse"` buttons (used in wasm.md) |
| `buildToc()` | Generates table of contents from h2/h3 headings, IntersectionObserver for active state |
| `initFadeIn()` | IntersectionObserver for `.fade-in` elements |
| `initNav()` | Scroll class on nav + hamburger toggle |
| `addRefTracking()` | Appends `?ref=loreley.one` to all external links automatically |

### SEO System (`head.ejs`)

Automatically handles for every page:
- **Description fallback chain**: `page.description` → `page.subtitle` → `strip_html(page.excerpt)` → `strip_html(page.content).substring(0,200)` → `config.description`
- **Schema type**: Uses `page.layout === 'post'` to distinguish blog posts from pages
- **JSON-LD**: `BlogPosting` for posts, `WebSite` for other pages
- **OG/Twitter cards**: Auto-detects `share_cover` from front matter; degrades to `summary` card without image
- **Canonical URL**: Auto-generated, strips trailing `index.html`
- **Article meta**: `article:published_time`, `article:author`, `article:tag` on posts

## Content Conventions

### Post Front Matter

All fields used by the template system:

```yaml
---
title: Post Title
date: 2024-03-16
tags: ["python", "models"]
subtitle: "Short tagline shown below title"
description: "SEO description for meta tags and social previews (1-2 sentences)"
author: Lukas
share_cover: 2024-03-post_slug/image.png  # Optional OG image (relative to post asset folder)
---
```

`description` and `subtitle` are important for SEO. Always provide `description` — it's the primary source for meta description tags and social previews.

### Code Blocks

Use fenced markdown code blocks with language annotation. Never use GitHub gist embeds.

````markdown
```python
def example():
    return True
```
````

Prism.js handles syntax highlighting. `main.js` auto-wraps code blocks with language labels and copy buttons.

### Math

Use hexo-math KaTeX tags (rendered at build time):

```markdown
Inline: {% katex %} E = mc^2 {% endkatex %}

Display: {% katex '{ "displayMode": true }' %} \sum_{i=1}^{n} x_i {% endkatex %}
```

### Images

Place in the post's asset folder (created automatically with `post_asset_folder: true`):

```markdown
{% raw %}
<center>
<img src="filename.png" alt="description">
<p><small>Caption text</small></p>
</center>
{% endraw %}
```

### Collapsible Sections

Use Bootstrap-style `data-toggle="collapse"` attributes (handled by `initCollapse()` in main.js):

```html
<button class="btn btn-primary" data-toggle="collapse" data-target="#section1">Toggle</button>
<div id="section1" class="collapse">Hidden content</div>
```

### External Links

All external links automatically get `?ref=loreley.one` appended via `addRefTracking()` in main.js. No need to add manually.

## Source Content (`source/`)

- `_posts/` — Blog posts (9 posts with asset folders)
- `about/`, `links/`, `services/`, `pitch/` — Static pages
- `drafts/` — Draft posts
- `robots.txt` — Includes sitemap reference
- `CNAME` — Custom domain config

## Deployment

```bash
hexo clean && hexo deploy
```

Deploys to `BasedLukas/BasedLukas.github.io` on the `gh-pages` branch. Domain: loreley.one.
